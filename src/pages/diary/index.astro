---
import { AppConfig } from '@/utils/AppConfig';
import Base from '@/layouts/Base.astro';
import Section from '@/components/Section.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

const { title, description } = AppConfig;

const allDiaries = await getCollection('diary');
allDiaries.sort((a, b) => 
    b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const groupedDiaries = allDiaries.reduce((acc, diary) => {
    const date = new Date(diary.data.pubDate);
    const year = date.getFullYear().toString();
    const month = date.toLocaleString('en-US', { month: 'long' });

    if (!acc[year]) acc[year] = {};
    if (!acc[year][month]) acc[year][month] = [];
    
    acc[year][month].push(diary);
    return acc;
}, {} as Record<string, Record<string, CollectionEntry<'diary'>[]>>);

const years = Object.keys(groupedDiaries).sort((a, b) => Number(b) - Number(a));

const monthOrder: Record<string, number> = {
  'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
  'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
};
---

<Base head={{ title: `Diary - ${title}`, description }}>
    
    <Section>
        <div class="py-12 md:py-20 text-center border-b border-gray-100 dark:border-white/5">
            <h1 class="text-4xl md:text-6xl font-bold tracking-tight text-gray-900 dark:text-white mb-4">
                Diary
            </h1>
            <p class="text-lg text-gray-500 font-medium tracking-wide opacity-80">
                碎碎念 / Personal Log
            </p>
        </div>
    </Section>

    <Section>
        <div class="py-10 space-y-20">
            {years.map(year => {
                const yearData = groupedDiaries[year]!;
                const months = Object.keys(yearData).sort((a, b) => (monthOrder[b] ?? 0) - (monthOrder[a] ?? 0));

                return (
                    <div class="relative">
                        <div class="sticky top-16 z-10 py-6 mb-8 bg-[#F5F5F7] dark:bg-black border-b border-gray-100 dark:border-white/5 transition-colors">
                            <h2 class="text-5xl font-bold text-gray-900 dark:text-white tracking-tighter select-none pl-2 md:pl-4">
                                {year}
                            </h2>
                        </div>

                        <div class="space-y-12 pl-2 md:pl-4">
                            {months.map(month => (
                                <div class="relative">
                                    <h3 class="flex items-center gap-4 text-sm font-bold uppercase tracking-widest text-blue-600 dark:text-blue-400 mb-6">
                                        <span class="w-2 h-2 rounded-full bg-blue-600 dark:bg-blue-400"></span>
                                        {month}
                                    </h3>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {yearData[month]!.map((post) => {
                                            const dateObj = new Date(post.data.pubDate);
                                            const day = dateObj.getDate().toString().padStart(2, '0');
                                            
                                            return (
                                                <a 
                                                    href={`/diary/${post.slug}`} 
                                                    class="group relative flex items-start gap-4 p-5 rounded-2xl bg-white border border-gray-100 shadow-sm transition-all duration-300 hover:shadow-md hover:-translate-y-0.5 hover:border-blue-100 dark:bg-[#1C1C1E] dark:border-white/5 dark:hover:border-white/10 dark:shadow-none"
                                                >
                                                    <div class="flex-shrink-0 flex flex-col items-center justify-center w-12 h-12 rounded-xl bg-gray-50 border border-gray-100 text-gray-900 dark:bg-white/5 dark:border-white/5 dark:text-white group-hover:bg-blue-50 group-hover:text-blue-600 dark:group-hover:bg-blue-500/10 dark:group-hover:text-blue-400 transition-colors">
                                                        <span class="text-lg font-bold font-mono leading-none">{day}</span>
                                                    </div>

                                                    <div class="flex-1 min-w-0 pt-0.5">
                                                        <h4 class="text-base font-bold text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                                                            {post.data.title}
                                                        </h4>
                                                        
                                                        {post.data.description && (
                                                            <p class="mt-1.5 text-sm text-gray-500 dark:text-gray-400 line-clamp-2 leading-relaxed">
                                                                {post.data.description}
                                                            </p>
                                                        )}
                                                    </div>

                                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 group-hover:text-blue-500">
                                                            <path d="m9 18 6-6-6-6"/>
                                                        </svg>
                                                    </div>
                                                </a>
                                            )
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
        
        <div class="pt-12 pb-20 text-center opacity-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </div>
    </Section>
</Base>