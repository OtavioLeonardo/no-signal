---
import { AppConfig } from '@/utils/AppConfig';
import Base from '@/layouts/Base.astro';
import Section from '@/components/Section.astro';
import Heading from '@/components/Heading.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

const { title } = AppConfig;
const { description } = AppConfig;

const allPosts = await getCollection('posts');

allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const groupedPosts = allPosts.reduce((acc, post) => {
    // 数据都在 .data 里
    const year = new Date(post.data.pubDate).getFullYear().toString();
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(post);
    return acc;
}, {} as Record<string, CollectionEntry<'posts'>[]>);

const years = Object.keys(groupedPosts).sort((a, b) => Number(b) - Number(a));
---

<Base head={{ title, description }}>
    <Section><Heading title="Posts" /></Section>
    
    <Section>
        {years.map((year) => (
            <div class="mb-10 last:mb-0">
                <h2 class="text-3xl font-bold text-stone-200 dark:text-stone-700 mb-6 pl-2 border-l-4 border-orange-500">
                    {year}
                </h2>

                <div class="flex flex-col">
                    {groupedPosts[year]!.map((post) => (
                        <a 
                            href={`/posts/${post.slug}`} 
                            class="group block py-4 border-b border-stone-200 dark:border-stone-800 hover:bg-stone-50 dark:hover:bg-stone-900/50 transition-colors px-3 -mx-3 rounded-lg"
                        >
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-baseline gap-1">
                                <h3 class="text-lg font-bold text-stone-800 dark:text-stone-200 group-hover:text-orange-600 transition-colors">
                                    {post.data.title}
                                </h3>
                                
                                <span class="font-mono text-sm text-stone-400 shrink-0">
                                    {new Date(post.data.pubDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                </span>
                            </div>

                            <div class="mt-1.5 flex flex-wrap gap-2">
                                {post.data.tags && post.data.tags.map((tag: string) => (
                                    <span class="text-xs font-mono px-1.5 py-0.5 rounded-md bg-stone-100 dark:bg-stone-800 text-stone-500 dark:text-stone-400 border border-stone-200 dark:border-stone-700">
                                        #{tag}
                                    </span>
                                ))}
                            </div>

                            <p class="text-sm text-stone-500 dark:text-stone-400 mt-2 line-clamp-1">
                                {post.data.description}
                            </p>
                        </a>
                    ))}
                </div>
            </div>
        ))}
    </Section>
</Base>