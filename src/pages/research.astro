---
import Base from '@/layouts/Base.astro'; // ç¡®ä¿è¿™é‡ŒæŒ‡å‘ä½ çš„ Layout æ–‡ä»¶
import Section from '@/components/Section.astro';
---

<Base head={{ title: 'Search', description: 'Search my blog' }}>
  <Section>
    <div class="py-12">
      <h1 class="text-3xl font-bold mb-8">ğŸ” Search</h1>
      
      <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
      
      <div id="search" class="p-4 bg-white dark:bg-stone-800 rounded-xl shadow-sm border border-stone-200 dark:border-stone-700"></div>
    </div>
  </Section>
</Base>

<script>
  import { PagefindUI } from "@pagefind/default-ui";

  document.addEventListener("DOMContentLoaded", () => {
    // 1. åˆå§‹åŒ– Pagefind
    new PagefindUI({
      element: "#search",
      showSubResults: true,
      resetStyles: false, // ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ CSS å˜é‡
      bundlePath: "/pagefind/", // ä¾ç„¶ä¿ç•™è¿™ä¸ªï¼Œé˜²æ­¢ Vercel æ‰¾ä¸åˆ°è·¯å¾„
    });

    // 2. è·å– DOM å…ƒç´ 
    const el = document.querySelector(".pagefind-ui");
    const input = el?.querySelector<HTMLInputElement>(`input[type="text"]`);
    const clearButton = el?.querySelector(".pagefind-ui__search-clear");

    // 3. æ£€æŸ¥ URL æ˜¯å¦æœ‰æŸ¥è¯¢å‚æ•° ?q=...
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    const query = params.get("q");

    // 4. å¦‚æœ URL é‡Œæœ‰å‚æ•°ï¼Œè‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†å¹¶è§¦å‘æœç´¢
    if (query && input) {
      input.value = query;
      // æ‰‹åŠ¨è§¦å‘ input äº‹ä»¶ï¼Œè®© Pagefind å¼€å§‹æœç´¢
      input.dispatchEvent(new Event("input", { bubbles: true }));
    }

    // 5. ç›‘å¬è¾“å…¥ï¼Œå®æ—¶æ›´æ–° URL å‚æ•°
    input?.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      
      if (target.value) {
        params.set("q", target.value);
      } else {
        params.delete("q");
      }
      
      // æ›´æ–°æµè§ˆå™¨åœ°å€æ è€Œä¸åˆ·æ–°é¡µé¢
      window.history.replaceState({}, "", `${url.pathname}?${params}`);
    });

    // 6. ç›‘å¬æ¸…é™¤æŒ‰é’®ï¼Œç‚¹å‡»æ—¶æ¸…ç©º URL å‚æ•°
    clearButton?.addEventListener("click", () => {
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      params.delete("q");
      window.history.replaceState({}, "", `${url.pathname}`);
    });
  });
</script>

<style is:global>
  /* å¤ç”¨ä½ ä¹‹å‰çš„æ ·å¼è®¾ç½®ï¼Œä¿è¯æ·±è‰²æ¨¡å¼å¥½çœ‹ */
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #ea580c;
    --pagefind-ui-text: #1c1917;
    --pagefind-ui-background: transparent;
    --pagefind-ui-border: #e7e5e4;
    --pagefind-ui-tag: #f5f5f4;
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-font: inherit; 
  }

  html.dark {
    --pagefind-ui-text: #fafaf9;
    --pagefind-ui-background: transparent;
    --pagefind-ui-border: #44403c;
    --pagefind-ui-tag: #292524;
  }

  .pagefind-ui__search-input {
    font-weight: normal;
  }
  
  .pagefind-ui__result-thumb {
    object-fit: cover;
  }
</style>