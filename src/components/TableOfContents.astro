---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// ✅ 修复点：加了 (headings || [])
// 如果 headings 是 undefined，就用空数组代替，防止 .filter 报错
const toc = (headings || []).filter((h) => h.depth > 1 && h.depth < 4);
---

{/* 只有当 toc 数组有内容时，才渲染下面的 HTML */}
{toc.length > 0 && (
  <nav class="toc-container text-sm">
    <h2 class="font-bold text-stone-900 dark:text-stone-100 mb-4 tracking-wider uppercase text-xs">
      On This Page
    </h2>
    <ul class="border-l border-stone-200 dark:border-stone-800">
      {toc.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class:list={[
              "toc-link block py-1.5 transition-all border-l-2 -ml-[2px] border-transparent", 
              // 基础颜色 (石色)
              "text-stone-500 dark:text-stone-500",
              // Hover 颜色 (橙色)
              "hover:text-orange-600 dark:hover:text-orange-500 hover:border-orange-300 dark:hover:border-orange-800",
              // 根据层级调整缩进
              heading.depth === 2 ? "pl-4" : "pl-8 text-xs"
            ]}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  :global(.toc-link.active) {
    color: #ea580c;
    font-weight: 700;
    border-left-color: #ea580c;
    background-color: #fff7ed; 
  }

  :global(html.dark .toc-link.active) {
    color: #f97316; 
    border-left-color: #f97316;
    background-color: #292524;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    
    if (tocLinks.length === 0) return;

    const headings = document.querySelectorAll('article h2, article h3');

    const observerOptions = {
      root: null,
      rootMargin: '-100px 0px -66% 0px', 
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          tocLinks.forEach((link) => link.classList.remove('active'));
          
          const id = entry.target.getAttribute('id');
          if (id) {
             const activeLink = document.querySelector(`.toc-link[href="#${CSS.escape(id)}"]`);
             if (activeLink) {
                activeLink.classList.add('active');
             }
          }
        }
      });
    }, observerOptions);

    headings.forEach((heading) => {
      observer.observe(heading);
    });
  });
</script>