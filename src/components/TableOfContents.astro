---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// 过滤掉 H1 和 H4+
const toc = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

<nav class="toc-container text-sm">
  <h2 class="font-bold text-stone-900 dark:text-stone-100 mb-4 tracking-wider uppercase text-xs">
    On This Page
  </h2>
  <ul class="border-l border-stone-200 dark:border-stone-800">
    {
      toc.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class:list={[
              "toc-link block py-1.5 transition-all border-l-2 -ml-[2px] border-transparent", 
              // 基础颜色 (石色)
              "text-stone-500 dark:text-stone-500",
              // Hover 颜色 (橙色)
              "hover:text-orange-600 dark:hover:text-orange-500 hover:border-orange-300 dark:hover:border-orange-800",
              // 根据层级调整缩进
              heading.depth === 2 ? "pl-4" : "pl-8 text-xs"
            ]}
          >
            {heading.text}
          </a>
        </li>
      ))
    }
  </ul>
</nav>

<style>
  /* * ✅ 修复方案：这里不再使用 @apply，而是使用原生 CSS。
   * 当 JavaScript 给元素加上 .active 类时，应用以下样式。
   * 颜色值对应 Tailwind 的 Orange-600 和 Stone/Orange 配色。
   */
  
  /* 亮色模式高亮 */
  :global(.toc-link.active) {
    color: #ea580c; /* orange-600 */
    font-weight: 700;
    border-left-color: #ea580c;
    background-color: #fff7ed; /* orange-50 */
  }

  /* 暗色模式高亮 (利用 html.dark 父级选择器) */
  :global(html.dark .toc-link.active) {
    color: #f97316; /* orange-500 */
    border-left-color: #f97316;
    background-color: #292524; /* stone-800 */
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('article h2, article h3');

    const observerOptions = {
      root: null,
      rootMargin: '-100px 0px -66% 0px', 
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          tocLinks.forEach((link) => link.classList.remove('active'));
          
          const id = entry.target.getAttribute('id');
          // 这里的 CSS 选择器必须加转义，以防 id 是数字开头
          if (id) {
             const activeLink = document.querySelector(`.toc-link[href="#${CSS.escape(id)}"]`);
             if (activeLink) {
               activeLink.classList.add('active');
             }
          }
        }
      });
    }, observerOptions);

    headings.forEach((heading) => {
      observer.observe(heading);
    });
  });
</script>