---
import { formatDate } from '@/utils/data.util';
import Section from './Section.astro';
import Tags from './Tags.astro';
import PinnedBadge from './PinnedBadge.astro';
import { Image } from 'astro:assets';

interface Props {
	title: string;
	author: string;
	tags: string[];
	minutesRead: string;
	pubDate: string;
	isPinned?: boolean;
	img: any;
}

const { title, pubDate, tags, minutesRead, img, isPinned = false } = Astro.props;
const formattedDate = formatDate(pubDate);

// 核心修复：智能提取图片路径
const getImgSrc = (imageProp: any) => {
    if (!imageProp) return null;
    
    // 情况 1：如果是字符串（直接的 URL 或 路径），直接返回
    if (typeof imageProp === 'string') return imageProp;
    
    // 情况 2：如果是 Astro 的 ImageMetadata（包含 format/width/height），直接返回对象
    if (imageProp.format) return imageProp;
    
    // 情况 3：如果是包装对象（{ src: "...", alt: "..." }），返回 .src
    return imageProp.src;
};

// 获取最终的 src 和 alt
const finalSrc = getImgSrc(img);
const finalAlt = (typeof img === 'object' && img?.alt) ? img.alt : title;
---

<Section>
	<div class="flex flex-col items-center max-w-3xl mx-auto">
        {/* Meta Info: Tags & Pinned */}
		<div class="flex flex-col items-center gap-4 mb-6">
            {isPinned && <PinnedBadge size="md" />}
			<Tags tags={tags} withHref={true} />
		</div>

        {/* Title: Big, Bold, Tight */}
		<h1 class="text-4xl md:text-5xl font-bold text-center tracking-tight leading-tight text-gray-900 dark:text-white mb-6">
			{title}
		</h1>

        {/* Date & Read Time */}
		<div class="flex items-center gap-3 text-sm font-medium text-gray-400 dark:text-gray-500 mb-10 uppercase tracking-widest">
			<span>{formattedDate}</span>
            <span class="w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-700"></span>
            <span>{minutesRead}</span>
		</div>

        {/* Hero Image: Rounded & Shadow */}
        {/* 使用处理过的 finalSrc */}
		{finalSrc && (
            <div class="w-full relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-gray-200 to-gray-100 rounded-2xl blur opacity-20 dark:opacity-10 transition duration-1000 group-hover:opacity-40"></div>
                
                <Image 
                    src={finalSrc} 
                    alt={finalAlt} 
                    class="relative w-full rounded-2xl shadow-sm border border-black/5 dark:border-white/10 dark:shadow-none"
                    width={1200}
                    height={630}
                />
            </div>
        )}
	</div>
</Section>